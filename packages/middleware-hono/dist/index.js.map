{"version":3,"sources":["../src/handlers.ts","../src/middleware.ts"],"names":["NetworkConfigs","PaymentScheme","decodeBase64","verifyPayment","settlePayment","encodeBase64"],"mappings":";;;;;AAQO,SAAS,iBAAA,CACd,MAAA,EACA,QAAA,EACA,EAAA,EACyB;AACzB,EAAA,MAAM,aAAA,GAAgBA,mBAAA,CAAe,MAAA,CAAO,OAAO,CAAA;AAEnD,EAAA,MAAM,cAAA,GAAiC;AAAA,IACrC,QAAQC,kBAAA,CAAc,iBAAA;AAAA,IACtB,WAAW,MAAA,CAAO,OAAA;AAAA,IAClB,OAAO,QAAA,CAAS,KAAA;AAAA,IAChB,QAAQ,QAAA,CAAS,MAAA;AAAA,IACjB,IAAI,MAAA,CAAO,gBAAA;AAAA,IACX,wBAAwB,MAAA,CAAO,sBAAA;AAAA,IAC/B,OAAA,EAAS;AAAA,MACP,MAAA,EAAQ;AAAA,QACN,IAAA,EAAM,MAAA;AAAA,QACN,OAAA,EAAS,GAAA;AAAA,QACT,SAAS,aAAA,CAAc,OAAA;AAAA,QACvB,mBAAmB,MAAA,CAAO;AAAA,OAC5B;AAAA,MACA,KAAA,EAAO;AAAA,QACL,OAAA,EAAS;AAAA,UACP,EAAE,IAAA,EAAM,OAAA,EAAS,IAAA,EAAM,SAAA,EAAU;AAAA,UACjC,EAAE,IAAA,EAAM,OAAA,EAAS,IAAA,EAAM,SAAA,EAAU;AAAA,UACjC,EAAE,IAAA,EAAM,QAAA,EAAU,IAAA,EAAM,SAAA,EAAU;AAAA,UAClC,EAAE,IAAA,EAAM,IAAA,EAAM,IAAA,EAAM,SAAA,EAAU;AAAA,UAC9B,EAAE,IAAA,EAAM,UAAA,EAAY,IAAA,EAAM,SAAA,EAAU;AAAA,UACpC,EAAE,IAAA,EAAM,WAAA,EAAa,IAAA,EAAM,SAAA,EAAU;AAAA,UACrC,EAAE,IAAA,EAAM,OAAA,EAAS,IAAA,EAAM,SAAA;AAAU;AACnC,OACF;AAAA,MACA,WAAA,EAAa,SAAA;AAAA,MACb,OAAA,EAAS;AAAA,QACP,KAAA,EAAO,4CAAA;AAAA;AAAA,QACP,OAAO,QAAA,CAAS,KAAA;AAAA,QAChB,MAAA,EAAQ,MAAA,CAAO,QAAA,CAAS,MAAM,CAAA;AAAA,QAC9B,IAAI,MAAA,CAAO,gBAAA;AAAA,QACX,QAAA,EAAU,OAAO,IAAA,CAAK,KAAA,CAAM,KAAK,GAAA,EAAI,GAAI,GAAI,CAAA,GAAI,GAAG,CAAA;AAAA,QACpD,SAAA,EAAW,oEAAA;AAAA,QACX,KAAA,EAAO,OAAO,CAAC;AAAA;AACjB,KACF;AAAA,IACA,aAAA,EAAe;AAAA,MACb,SAAS,aAAA,CAAc,OAAA;AAAA,MACvB,SAAS,MAAA,CAAO,sBAAA;AAAA,MAChB,KAAA,EAAO;AAAA;AACT,GACF;AAEA,EAAA,MAAM,QAAA,GAAoC;AAAA,IACxC,WAAA,EAAa,CAAA;AAAA,IACb,OAAA,EAAS,CAAC,cAAc;AAAA,GAC1B;AAEA,EAAA,OAAO,QAAA;AACT;AAKO,SAAS,eAAA,CACd,CAAA,EACA,MAAA,EACA,QAAA,EACU;AACV,EAAA,MAAM,QAAA,GAAW,iBAAA,CAAkB,MAAA,EAAQ,QAAW,CAAA;AAEtD,EAAA,OAAO,CAAA,CAAE,IAAA,CAAK,QAAA,EAAU,GAAG,CAAA;AAC7B;;;ACpEA,IAAM,gBAAA,GAAmB,WAAA;AAKzB,IAAM,yBAAA,GAA4B,oBAAA;AAe3B,SAAS,qBACd,MAAA,EAKC;AACD,EAAA,OAAO,OAAO,GAAY,IAAA,KAAe;AACvC,IAAA,IAAI;AAEF,MAAA,MAAM,QAAA,GAAW,MAAA,CAAO,SAAA,CAAU,IAAA,CAAK,CAAC,OAAO,CAAA,CAAE,GAAA,CAAI,IAAA,KAAS,EAAA,CAAG,IAAI,CAAA;AAErE,MAAA,IAAI,CAAC,QAAA,EAAU;AAEb,QAAA,MAAM,IAAA,EAAK;AACX,QAAA;AAAA,MACF;AAGA,MAAA,MAAM,aAAA,GAAgB,CAAA,CAAE,GAAA,CAAI,MAAA,CAAO,gBAAgB,CAAA;AAEnD,MAAA,IAAI,CAAC,aAAA,EAAe;AAElB,QAAA,OAAO,eAAA,CAAgB,CAAA,EAAG,MAAA,EAAQ,QAAQ,CAAA;AAAA,MAC5C;AAGA,MAAA,IAAI,OAAA;AACJ,MAAA,IAAI;AACF,QAAA,OAAA,GAAUC,kBAAmC,aAAa,CAAA;AAAA,MAC5D,CAAA,CAAA,MAAQ;AACN,QAAA,OAAO,CAAA,CAAE,IAAA;AAAA,UACP;AAAA,YACE,KAAA,EAAO;AAAA,WACT;AAAA,UACA;AAAA,SACF;AAAA,MACF;AAGA,MAAA,MAAM,kBAAA,GAAqB,MAAMC,kBAAA,CAAc,OAAO,CAAA;AAEtD,MAAA,IAAI,CAAC,mBAAmB,OAAA,EAAS;AAC/B,QAAA,OAAO,CAAA,CAAE,IAAA;AAAA,UACP;AAAA,YACE,WAAA,EAAa,CAAA;AAAA,YACb,SAAS,EAAC;AAAA,YACV,KAAA,EAAO,CAAA,6BAAA,EAAgC,kBAAA,CAAmB,aAAa,CAAA;AAAA,WACzE;AAAA,UACA;AAAA,SACF;AAAA,MACF;AAGA,MAAA,CAAA,CAAE,IAAI,SAAA,EAAW;AAAA,QACf,QAAA,EAAU,IAAA;AAAA,QACV,OAAO,kBAAA,CAAmB,KAAA;AAAA,QAC1B,QAAQ,QAAA,IAAY,OAAA,CAAQ,cAAA,GAAiB,OAAA,CAAQ,eAAe,MAAA,GAAS,KAAA,CAAA;AAAA,QAC7E,OAAO,OAAA,IAAW,OAAA,CAAQ,cAAA,GAAiB,OAAA,CAAQ,eAAe,KAAA,GAAQ,KAAA;AAAA,OAC3E,CAAA;AAGD,MAAA,IAAI,MAAA,CAAO,eAAe,KAAA,EAAO;AAC/B,QAAA,IAAI;AACF,UAAA,MAAM,gBAAA,GAAmB,MAAMC,kBAAA,CAAc,MAAA,CAAO,cAAc,OAAO,CAAA;AAEzE,UAAA,IAAI,iBAAiB,OAAA,EAAS;AAE5B,YAAA,MAAM,iBAAA,GAA8C;AAAA,cAClD,QAAQ,gBAAA,CAAiB,MAAA;AAAA,cACzB,aAAa,gBAAA,CAAiB,WAAA;AAAA,cAC9B,MAAA,EAAQ;AAAA,aACV;AAEA,YAAA,CAAA,CAAE,MAAA,CAAO,yBAAA,EAA2BC,iBAAA,CAAa,iBAAiB,CAAC,CAAA;AAAA,UACrE,CAAA,MAAO;AACL,YAAA,OAAA,CAAQ,KAAA,CAAM,oBAAA,EAAsB,gBAAA,CAAiB,KAAK,CAAA;AAAA,UAE5D;AAAA,QACF,SAAS,KAAA,EAAO;AACd,UAAA,OAAA,CAAQ,KAAA,CAAM,qBAAqB,KAAK,CAAA;AAAA,QAE1C;AAAA,MACF;AAGA,MAAA,MAAM,IAAA,EAAK;AAAA,IACb,SAAS,KAAA,EAAO;AACd,MAAA,OAAA,CAAQ,KAAA,CAAM,qBAAqB,KAAK,CAAA;AACxC,MAAA,OAAO,CAAA,CAAE,IAAA;AAAA,QACP;AAAA,UACE,KAAA,EAAO;AAAA,SACT;AAAA,QACA;AAAA,OACF;AAAA,IACF;AAAA,EACF,CAAA;AACF","file":"index.js","sourcesContent":["import type { Context } from \"hono\";\nimport type { PaymentRequiredResponse, PaymentDetails } from \"@q402/core\";\nimport { PaymentScheme, NetworkConfigs } from \"@q402/core\";\nimport type { PaymentEndpointConfig, Q402MiddlewareConfig } from \"./config\";\n\n/**\n * Create 402 Payment Required response\n */\nexport function create402Response(\n  config: Q402MiddlewareConfig,\n  endpoint: PaymentEndpointConfig,\n  _c: Context,\n): PaymentRequiredResponse {\n  const networkConfig = NetworkConfigs[config.network];\n\n  const paymentDetails: PaymentDetails = {\n    scheme: PaymentScheme.EIP7702_DELEGATED,\n    networkId: config.network,\n    token: endpoint.token,\n    amount: endpoint.amount,\n    to: config.recipientAddress,\n    implementationContract: config.implementationContract,\n    witness: {\n      domain: {\n        name: \"q402\",\n        version: \"1\",\n        chainId: networkConfig.chainId,\n        verifyingContract: config.verifyingContract,\n      },\n      types: {\n        Witness: [\n          { name: \"owner\", type: \"address\" },\n          { name: \"token\", type: \"address\" },\n          { name: \"amount\", type: \"uint256\" },\n          { name: \"to\", type: \"address\" },\n          { name: \"deadline\", type: \"uint256\" },\n          { name: \"paymentId\", type: \"bytes32\" },\n          { name: \"nonce\", type: \"uint256\" },\n        ],\n      },\n      primaryType: \"Witness\",\n      message: {\n        owner: \"0x0000000000000000000000000000000000000000\", // Placeholder\n        token: endpoint.token,\n        amount: BigInt(endpoint.amount),\n        to: config.recipientAddress,\n        deadline: BigInt(Math.floor(Date.now() / 1000) + 900),\n        paymentId: \"0x0000000000000000000000000000000000000000000000000000000000000000\",\n        nonce: BigInt(0),\n      },\n    },\n    authorization: {\n      chainId: networkConfig.chainId,\n      address: config.implementationContract,\n      nonce: 0,\n    },\n  };\n\n  const response: PaymentRequiredResponse = {\n    x402Version: 1,\n    accepts: [paymentDetails],\n  };\n\n  return response;\n}\n\n/**\n * Send 402 Payment Required response\n */\nexport function send402Response(\n  c: Context,\n  config: Q402MiddlewareConfig,\n  endpoint: PaymentEndpointConfig,\n): Response {\n  const response = create402Response(config, endpoint, c);\n\n  return c.json(response, 402);\n}\n\n","import type { Context, Next, MiddlewareHandler } from \"hono\";\nimport { decodeBase64, verifyPayment, settlePayment, encodeBase64 } from \"@q402/core\";\nimport type { SignedPaymentPayload, PaymentExecutionResponse } from \"@q402/core\";\nimport type { Q402MiddlewareConfig } from \"./config\";\nimport { send402Response } from \"./handlers\";\n\n/**\n * X-PAYMENT header name\n */\nconst X_PAYMENT_HEADER = \"x-payment\";\n\n/**\n * X-PAYMENT-RESPONSE header name\n */\nconst X_PAYMENT_RESPONSE_HEADER = \"x-payment-response\";\n\n/**\n * Payment context type\n */\nexport interface PaymentContext {\n  verified: boolean;\n  payer: string;\n  amount: string;\n  token: string;\n}\n\n/**\n * Create q402 payment middleware for Hono\n */\nexport function createQ402Middleware(\n  config: Q402MiddlewareConfig,\n): MiddlewareHandler<{\n  Variables: {\n    payment?: PaymentContext;\n  };\n}> {\n  return async (c: Context, next: Next) => {\n    try {\n      // Find matching endpoint\n      const endpoint = config.endpoints.find((ep) => c.req.path === ep.path);\n\n      if (!endpoint) {\n        // Not a protected endpoint\n        await next();\n        return;\n      }\n\n      // Check for X-PAYMENT header\n      const paymentHeader = c.req.header(X_PAYMENT_HEADER);\n\n      if (!paymentHeader) {\n        // No payment header - return 402\n        return send402Response(c, config, endpoint);\n      }\n\n      // Decode payment payload\n      let payload: SignedPaymentPayload;\n      try {\n        payload = decodeBase64<SignedPaymentPayload>(paymentHeader);\n      } catch {\n        return c.json(\n          {\n            error: \"Invalid payment header format\",\n          },\n          400,\n        );\n      }\n\n      // Verify payment\n      const verificationResult = await verifyPayment(payload);\n\n      if (!verificationResult.isValid) {\n        return c.json(\n          {\n            x402Version: 1,\n            accepts: [],\n            error: `Payment verification failed: ${verificationResult.invalidReason}`,\n          },\n          402,\n        );\n      }\n\n      // Verification succeeded - attach payment info to context\n      c.set(\"payment\", {\n        verified: true,\n        payer: verificationResult.payer!,\n        amount: \"amount\" in payload.paymentDetails ? payload.paymentDetails.amount : undefined,\n        token: \"token\" in payload.paymentDetails ? payload.paymentDetails.token : undefined,\n      });\n\n      // Settle payment if auto-settle is enabled\n      if (config.autoSettle !== false) {\n        try {\n          const settlementResult = await settlePayment(config.walletClient, payload);\n\n          if (settlementResult.success) {\n            // Add settlement response header\n            const executionResponse: PaymentExecutionResponse = {\n              txHash: settlementResult.txHash!,\n              blockNumber: settlementResult.blockNumber,\n              status: \"confirmed\",\n            };\n\n            c.header(X_PAYMENT_RESPONSE_HEADER, encodeBase64(executionResponse));\n          } else {\n            console.error(\"Settlement failed:\", settlementResult.error);\n            // Continue anyway - payment was verified\n          }\n        } catch (error) {\n          console.error(\"Settlement error:\", error);\n          // Continue anyway - payment was verified\n        }\n      }\n\n      // Continue to route handler\n      await next();\n    } catch (error) {\n      console.error(\"Middleware error:\", error);\n      return c.json(\n        {\n          error: \"Internal server error\",\n        },\n        500,\n      );\n    }\n  };\n}\n\n"]}